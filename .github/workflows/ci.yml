name: CI/CD Pipeline - Focus PWAname: CI/CD Pipeline - Focus PWAname: CI/CD Pipeline - Focus PWAname: CI/CD Pipeline - Focus PWAname: CI - Focus Extension



on:

  push:

    branches: [main]on:

  pull_request:

    branches: [main]  push:

  workflow_dispatch:

    branches: [ main ]on:

env:

  NODE_VERSION: '20'  pull_request:



jobs:    branches: [ main ]  push:

  build-and-test:

    name: Build & Unit Tests  workflow_dispatch:

    runs-on: ubuntu-latest

        branches: [ main ]on:on:

    steps:

      - name: Checkout codeenv:

        uses: actions/checkout@v4

        NODE_VERSION: '20'  pull_request:

      - name: Setup Node.js

        uses: actions/setup-node@v4

        with:

          node-version: ${{ env.NODE_VERSION }}jobs:    branches: [ main ]  push:  push:

          cache: 'npm'

        build-and-test:

      - name: Install root dependencies

        run: npm ci    name: Build & Unit Tests  workflow_dispatch:

      

      - name: Install API dependencies    runs-on: ubuntu-latest

        working-directory: ./apps/api

        run: npm ci        branches: [ main, develop ]    branches: [ main ]

      

      - name: Install Web dependencies    steps:

        working-directory: ./apps/web

        run: npm ci      - name: ðŸ“¥ Checkout codeenv:

      

      - name: Run unit tests API        uses: actions/checkout@v4

        working-directory: ./apps/api

        run: npm test --if-present        NODE_VERSION: '20'  pull_request:  pull_request:

      

      - name: Run unit tests Web      - name: ðŸŸ¢ Setup Node.js

        working-directory: ./apps/web

        run: npm test --if-present        uses: actions/setup-node@v4

      

      - name: Build Web PWA        with:

        working-directory: ./apps/web

        run: npm run build          node-version: ${{ env.NODE_VERSION }}jobs:    branches: [ main ]    branches: [ main ]

      

      - name: Upload build artifacts          cache: 'npm'

        uses: actions/upload-artifact@v4

        with:        build-and-test:

          name: web-dist

          path: apps/web/dist      - name: ðŸ“¦ Install root dependencies

          retention-days: 7

        run: npm ci    name: Build & Unit Tests  workflow_dispatch:  workflow_dispatch: # Permite execuÃ§Ã£o manual

  e2e-tests:

    name: E2E Tests with Playwright      

    runs-on: ubuntu-latest

    needs: build-and-test      - name: ðŸ“¦ Install API dependencies    runs-on: ubuntu-latest

    

    steps:        working-directory: ./apps/api

      - name: Checkout code

        uses: actions/checkout@v4        run: npm ci    

      

      - name: Setup Node.js      

        uses: actions/setup-node@v4

        with:      - name: ðŸ“¦ Install Web dependencies    steps:

          node-version: ${{ env.NODE_VERSION }}

          cache: 'npm'        working-directory: ./apps/web

      

      - name: Install root dependencies        run: npm ci      - name: ðŸ“¥ Checkout codeenv:jobs:

        run: npm ci

            

      - name: Install API dependencies

        working-directory: ./apps/api      - name: ðŸ§ª Run unit tests (API)        uses: actions/checkout@v4

        run: npm ci

              working-directory: ./apps/api

      - name: Install Web dependencies

        working-directory: ./apps/web        run: npm test --if-present        NODE_VERSION: '20'  test-build:

        run: npm ci

            

      - name: Install Playwright browsers

        run: npx playwright install --with-deps chromium      - name: ðŸ§ª Run unit tests (Web)      - name: ðŸŸ¢ Setup Node.js

      

      - name: Start services with Docker Compose        working-directory: ./apps/web

        run: |

          docker-compose up -d api web        run: npm test --if-present        uses: actions/setup-node@v4    name: Build e Test E2E

          docker-compose ps

            

      - name: Wait for services

        run: |      - name: ðŸ—ï¸ Build Web PWA        with:

          echo "Waiting for API..."

          timeout 60 bash -c 'until curl -f http://localhost:3000/api/health; do sleep 2; done' || echo "API timeout"        working-directory: ./apps/web

          echo "Waiting for Web..."

          timeout 60 bash -c 'until curl -f http://localhost:8080; do sleep 2; done' || echo "Web timeout"        run: npm run build          node-version: ${{ env.NODE_VERSION }}jobs:    runs-on: ubuntu-latest

      

      - name: Run E2E tests        env:

        run: npx playwright test

        env:          VITE_API_URL: https://focus-api.onrender.com          cache: 'npm'

          E2E_BASE_URL: http://localhost:8080

          API_URL: http://localhost:3000      

      

      - name: Upload Playwright Report      - name: ðŸ“¤ Upload build artifacts        build-and-test:    

        if: always()

        uses: actions/upload-artifact@v4        uses: actions/upload-artifact@v4

        with:

          name: playwright-report        with:      - name: ðŸ“¦ Install dependencies (Root)

          path: playwright-report

          retention-days: 30          name: web-dist

      

      - name: Stop Docker services          path: apps/web/dist        run: npm ci    name: Build & Test    steps:

        if: always()

        run: docker-compose down          retention-days: 7



  deploy-pages:      

    name: Deploy to GitHub Pages

    runs-on: ubuntu-latest  e2e-tests:

    needs: [build-and-test, e2e-tests]

    if: github.ref == 'refs/heads/main' && github.event_name == 'push'    name: E2E Tests with Playwright      - name: ðŸ“¦ Install dependencies (API)    runs-on: ubuntu-latest      - name: Checkout cÃ³digo

    

    permissions:    runs-on: ubuntu-latest

      contents: read

      pages: write    needs: build-and-test        working-directory: ./apps/api

      id-token: write

        

    environment:

      name: github-pages    steps:        run: npm ci            uses: actions/checkout@v4

      url: ${{ steps.deployment.outputs.page_url }}

          - name: ðŸ“¥ Checkout code

    steps:

      - name: Checkout code        uses: actions/checkout@v4      

        uses: actions/checkout@v4

            

      - name: Setup Node.js

        uses: actions/setup-node@v4      - name: ðŸŸ¢ Setup Node.js      - name: ðŸ“¦ Install dependencies (Web)    strategy:      

        with:

          node-version: ${{ env.NODE_VERSION }}        uses: actions/setup-node@v4

          cache: 'npm'

              with:        working-directory: ./apps/web

      - name: Install Web dependencies

        working-directory: ./apps/web          node-version: ${{ env.NODE_VERSION }}

        run: npm ci

                cache: 'npm'        run: npm ci      matrix:      - name: Setup Node.js

      - name: Build for Production

        working-directory: ./apps/web      

        run: npm run build

            - name: ðŸ“¦ Install root dependencies      

      - name: Setup Pages

        uses: actions/configure-pages@v4        run: npm ci

      

      - name: Upload artifact            - name: ðŸ§ª Run unit tests (API)        node-version: [20]        uses: actions/setup-node@v4

        uses: actions/upload-pages-artifact@v3

        with:      - name: ðŸ“¦ Install API dependencies

          path: ./apps/web/dist

              working-directory: ./apps/api        working-directory: ./apps/api

      - name: Deploy to GitHub Pages

        id: deployment        run: npm ci

        uses: actions/deploy-pages@v4

              run: npm test --if-present            with:

  summary:

    name: CI/CD Summary      - name: ðŸ“¦ Install Web dependencies

    runs-on: ubuntu-latest

    needs: [build-and-test, e2e-tests, deploy-pages]        working-directory: ./apps/web      

    if: always()

            run: npm ci

    steps:

      - name: Generate Summary            - name: ðŸ§ª Run unit tests (Web)    steps:          node-version: '20'

        run: |

          echo "## CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY      - name: ðŸ“¦ Install Playwright browsers

          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Jobs Status:" >> $GITHUB_STEP_SUMMARY        run: npx playwright install --with-deps chromium        working-directory: ./apps/web

          echo "- Build & Tests: ${{ needs.build-and-test.result }}" >> $GITHUB_STEP_SUMMARY

          echo "- E2E Tests: ${{ needs.e2e-tests.result }}" >> $GITHUB_STEP_SUMMARY      

          echo "- Deploy Pages: ${{ needs.deploy-pages.result }}" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY      - name: ðŸ³ Start services with Docker Compose        run: npm test --if-present      - name: ðŸ“¥ Checkout code      

          echo "### Links:" >> $GITHUB_STEP_SUMMARY

          echo "- [PWA Live](https://edumanzur.github.io/bootcamp2-chrome-ext-Eduardo-Manzur/)" >> $GITHUB_STEP_SUMMARY        run: |


          docker-compose up -d api web      

          docker-compose ps

            - name: ðŸ—ï¸ Build Web PWA        uses: actions/checkout@v4      - name: Instalar dependÃªncias

      - name: â³ Wait for services to be ready

        run: |        working-directory: ./apps/web

          echo "Waiting for API..."

          timeout 60 bash -c 'until curl -f http://localhost:3000/api/health; do sleep 2; done' || echo "API timeout"        run: npm run build              run: npm install

          echo "Waiting for Web..."

          timeout 60 bash -c 'until curl -f http://localhost:8080; do sleep 2; done' || echo "Web timeout"        env:

          echo "Services status:"

          docker-compose ps          VITE_API_URL: https://focus-api.onrender.com      - name: ðŸŸ¢ Setup Node.js ${{ matrix.node-version }}      

          docker-compose logs api

          docker-compose logs web      

      

      - name: ðŸ§ª Run E2E tests      - name: ðŸ“¤ Upload build artifacts        uses: actions/setup-node@v4      - name: Instalar Playwright Chromium

        run: npx playwright test

        env:        uses: actions/upload-artifact@v4

          E2E_BASE_URL: http://localhost:8080

          API_URL: http://localhost:3000        with:        with:        run: npx playwright install --with-deps chromium

      

      - name: ðŸ“Š Upload Playwright Report          name: web-dist

        if: always()

        uses: actions/upload-artifact@v4          path: apps/web/dist          node-version: ${{ matrix.node-version }}      

        with:

          name: playwright-report          retention-days: 7

          path: playwright-report

          retention-days: 30          cache: 'npm'      - name: Build da extensÃ£o

      

      - name: ðŸ“Š Upload test results  e2e-tests:

        if: always()

        uses: actions/upload-artifact@v4    name: E2E Tests with Playwright              run: npm run build

        with:

          name: test-results    runs-on: ubuntu-latest

          path: test-results

          retention-days: 30    needs: build-and-test      - name: ðŸ“¦ Install dependencies (API)      

      

      - name: ðŸ³ Docker logs (on failure)    

        if: failure()

        run: |    steps:        working-directory: ./apps/api      - name: Verificar arquivos gerados

          echo "=== API Logs ==="

          docker-compose logs api      - name: ðŸ“¥ Checkout code

          echo "=== Web Logs ==="

          docker-compose logs web        uses: actions/checkout@v4        run: npm ci        run: |

      

      - name: ðŸ³ Stop Docker services      

        if: always()

        run: docker-compose down      - name: ðŸŸ¢ Setup Node.js                ls -la dist/



  lighthouse:        uses: actions/setup-node@v4

    name: Lighthouse CI

    runs-on: ubuntu-latest        with:      - name: ðŸ“¦ Install dependencies (Web)          test -f dist/extension.zip && echo "âœ… extension.zip criado" || echo "âŒ extension.zip nÃ£o encontrado"

    needs: build-and-test

              node-version: ${{ env.NODE_VERSION }}

    steps:

      - name: ðŸ“¥ Checkout code              working-directory: ./apps/web      

        uses: actions/checkout@v4

            - name: ðŸ“¦ Install dependencies

      - name: ðŸŸ¢ Setup Node.js

        uses: actions/setup-node@v4        run: |        run: npm ci      - name: Executar testes E2E

        with:

          node-version: ${{ env.NODE_VERSION }}          npm ci

          cache: 'npm'

                cd apps/api && npm ci              run: npm run test:e2e

      - name: ðŸ“¦ Install dependencies

        run: |          cd ../web && npm ci

          npm ci

          cd apps/api && npm ci            - name: ðŸ§ª Run unit tests (API)        continue-on-error: false

          cd ../web && npm ci

            - name: ðŸ“¦ Install Playwright

      - name: ðŸ³ Start services

        run: |        run: npx playwright install --with-deps chromium        working-directory: ./apps/api      

          docker-compose up -d api web

          timeout 60 bash -c 'until curl -f http://localhost:8080; do sleep 2; done'      

      

      - name: ðŸ“Š Run Lighthouse CI      - name: ðŸ³ Start services with Docker Compose        run: npm test --if-present      - name: Publicar relatÃ³rio do Playwright

        run: |

          npm install -g @lhci/cli        run: |

          lhci autorun

        env:          docker-compose up -d api web              if: always()

          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

        continue-on-error: true          docker-compose ps

      

      - name: ðŸ“¤ Upload Lighthouse results            - name: ðŸ§ª Run unit tests (Web)        uses: actions/upload-artifact@v4

        if: always()

        uses: actions/upload-artifact@v4      - name: â³ Wait for services

        with:

          name: lighthouse-results        run: |        working-directory: ./apps/web        with:

          path: .lighthouseci

          retention-days: 30          echo "Aguardando API..."

      

      - name: ðŸ³ Stop services          timeout 60 bash -c 'until curl -f http://localhost:3000/api/health; do sleep 2; done'        run: npm test --if-present          name: playwright-report

        if: always()

        run: docker-compose down          echo "Aguardando Web..."



  deploy-pages:          timeout 60 bash -c 'until curl -f http://localhost:8080; do sleep 2; done'                path: playwright-report

    name: Deploy to GitHub Pages

    runs-on: ubuntu-latest      

    needs: [build-and-test, e2e-tests]

    if: github.ref == 'refs/heads/main' && github.event_name == 'push'      - name: ðŸ§ª Run E2E tests      - name: ðŸ—ï¸ Build Web PWA          retention-days: 30

    

    permissions:        run: npx playwright test

      contents: read

      pages: write        env:        working-directory: ./apps/web      

      id-token: write

              E2E_BASE_URL: http://localhost:8080

    environment:

      name: github-pages          API_URL: http://localhost:3000        run: npm run build      - name: Publicar pacote da extensÃ£o

      url: ${{ steps.deployment.outputs.page_url }}

          

    steps:

      - name: ðŸ“¥ Checkout code      - name: ðŸ“Š Upload Playwright Report        env:        if: success()

        uses: actions/checkout@v4

              if: always()

      - name: ðŸŸ¢ Setup Node.js

        uses: actions/setup-node@v4        uses: actions/upload-artifact@v4          VITE_API_URL: https://focus-api.onrender.com        uses: actions/upload-artifact@v4

        with:

          node-version: ${{ env.NODE_VERSION }}        with:

          cache: 'npm'

                name: playwright-report              with:

      - name: ðŸ“¦ Install Web dependencies

        working-directory: ./apps/web          path: playwright-report

        run: npm ci

                retention-days: 30      - name: ðŸ“¤ Upload build artifacts          name: extension-zip

      - name: ðŸ—ï¸ Build for Production

        working-directory: ./apps/web      

        run: npm run build

        env:      - name: ðŸ³ Stop Docker services        uses: actions/upload-artifact@v4          path: dist/extension.zip

          VITE_API_URL: https://focus-api.onrender.com

              if: always()

      - name: ðŸ“„ Setup Pages

        uses: actions/configure-pages@v4        run: docker-compose down        with:          retention-days: 90

      

      - name: ðŸ“¤ Upload artifact

        uses: actions/upload-pages-artifact@v3

        with:  lighthouse:          name: web-dist      

          path: ./apps/web/dist

          name: Lighthouse CI

      - name: ðŸš€ Deploy to GitHub Pages

        id: deployment    runs-on: ubuntu-latest          path: apps/web/dist      - name: Publicar dist completo

        uses: actions/deploy-pages@v4

    needs: build-and-test

  docker-build:

    name: Build Docker Images              retention-days: 7        if: success()

    runs-on: ubuntu-latest

    needs: build-and-test    steps:

    

    steps:      - name: ðŸ“¥ Checkout code          uses: actions/upload-artifact@v4

      - name: ðŸ“¥ Checkout code

        uses: actions/checkout@v4        uses: actions/checkout@v4

      

      - name: ðŸ³ Set up Docker Buildx        e2e-tests:        with:

        uses: docker/setup-buildx-action@v3

            - name: ðŸŸ¢ Setup Node.js

      - name: ðŸ—ï¸ Build API Image

        uses: docker/build-push-action@v5        uses: actions/setup-node@v4    name: E2E Tests with Playwright          name: extension-dist

        with:

          context: ./apps/api        with:

          file: ./apps/api/Dockerfile

          push: false          node-version: ${{ env.NODE_VERSION }}    runs-on: ubuntu-latest          path: dist/

          tags: focus-api:latest

          cache-from: type=gha      

          cache-to: type=gha,mode=max

            - name: ðŸ“¦ Install dependencies    needs: build-and-test          retention-days: 30

      - name: ðŸ—ï¸ Build Web Image

        uses: docker/build-push-action@v5        run: |

        with:

          context: ./apps/web          npm ci    

          file: ./apps/web/Dockerfile

          push: false          cd apps/api && npm ci    steps:

          tags: focus-web:latest

          cache-from: type=gha          cd ../web && npm ci      - name: ðŸ“¥ Checkout code

          cache-to: type=gha,mode=max

              uses: actions/checkout@v4

  summary:

    name: CI/CD Summary      - name: ðŸ³ Start services      

    runs-on: ubuntu-latest

    needs: [build-and-test, e2e-tests, lighthouse, deploy-pages, docker-build]        run: |      - name: ðŸŸ¢ Setup Node.js

    if: always()

              docker-compose up -d api web        uses: actions/setup-node@v4

    steps:

      - name: ðŸ“Š Generate Summary          timeout 60 bash -c 'until curl -f http://localhost:8080; do sleep 2; done'        with:

        run: |

          echo "## ðŸŽ¯ CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY                node-version: ${{ env.NODE_VERSION }}

          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Jobs Status:" >> $GITHUB_STEP_SUMMARY      - name: ðŸ“Š Run Lighthouse CI      

          echo "- âœ… Build & Tests: ${{ needs.build-and-test.result }}" >> $GITHUB_STEP_SUMMARY

          echo "- ðŸ§ª E2E Tests: ${{ needs.e2e-tests.result }}" >> $GITHUB_STEP_SUMMARY        run: |      - name: ðŸ“¦ Install Playwright

          echo "- ðŸ“Š Lighthouse: ${{ needs.lighthouse.result }}" >> $GITHUB_STEP_SUMMARY

          echo "- ðŸš€ Deploy Pages: ${{ needs.deploy-pages.result }}" >> $GITHUB_STEP_SUMMARY          npm install -g @lhci/cli        run: |

          echo "- ðŸ³ Docker Build: ${{ needs.docker-build.result }}" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY          lhci autorun          npm ci

          echo "### ðŸ”— Links:" >> $GITHUB_STEP_SUMMARY

          echo "- [PWA Live](https://edumanzur.github.io/bootcamp2-chrome-ext-Eduardo-Manzur/)" >> $GITHUB_STEP_SUMMARY        env:          npx playwright install --with-deps chromium

          echo "- [Repository](https://github.com/edumanzur/bootcamp2-chrome-ext-Eduardo-Manzur)" >> $GITHUB_STEP_SUMMARY

          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}      

            - name: ðŸ³ Start services with Docker Compose

      - name: ðŸ“¤ Upload Lighthouse results        run: |

        if: always()          docker-compose up -d api web

        uses: actions/upload-artifact@v4          docker-compose ps

        with:      

          name: lighthouse-results      - name: â³ Wait for services

          path: .lighthouseci        run: |

          retention-days: 30          echo "Aguardando API..."

                timeout 60 bash -c 'until curl -f http://localhost:3000/api/health; do sleep 2; done'

      - name: ðŸ³ Stop services          echo "Aguardando Web..."

        if: always()          timeout 60 bash -c 'until curl -f http://localhost:8080/health; do sleep 2; done'

        run: docker-compose down      

      - name: ðŸ§ª Run E2E tests

  deploy-pages:        run: npx playwright test tests/pwa.spec.ts

    name: Deploy to GitHub Pages        env:

    runs-on: ubuntu-latest          E2E_BASE_URL: http://localhost:8080

    needs: [build-and-test, e2e-tests]          API_URL: http://localhost:3000

    if: github.ref == 'refs/heads/main' && github.event_name == 'push'      

          - name: ðŸ“¸ Upload Playwright Report

    permissions:        if: always()

      contents: read        uses: actions/upload-artifact@v4

      pages: write        with:

      id-token: write          name: playwright-report

              path: playwright-report/

    environment:          retention-days: 7

      name: github-pages      

      url: ${{ steps.deployment.outputs.page_url }}      - name: ðŸ“Š Upload Test Results

            if: always()

    steps:        uses: actions/upload-artifact@v4

      - name: ðŸ“¥ Checkout code        with:

        uses: actions/checkout@v4          name: test-results

                path: test-results.json

      - name: ðŸŸ¢ Setup Node.js          retention-days: 7

        uses: actions/setup-node@v4      

        with:      - name: ðŸ›‘ Stop Docker Compose

          node-version: ${{ env.NODE_VERSION }}        if: always()

              run: docker-compose down

      - name: ðŸ“¦ Install dependencies (Web)  

        working-directory: ./apps/web  lighthouse:

        run: npm ci    name: Lighthouse Audit

          runs-on: ubuntu-latest

      - name: ðŸ—ï¸ Build for Production    needs: build-and-test

        working-directory: ./apps/web    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

        run: npm run build    

        env:    steps:

          VITE_API_URL: https://focus-api.onrender.com      - name: ðŸ“¥ Checkout code

              uses: actions/checkout@v4

      - name: ðŸ“„ Setup Pages      

        uses: actions/configure-pages@v4      - name: ðŸ“¥ Download build artifacts

              uses: actions/download-artifact@v4

      - name: ðŸ“¤ Upload artifact        with:

        uses: actions/upload-pages-artifact@v3          name: web-dist

        with:          path: apps/web/dist

          path: ./apps/web/dist      

            - name: ðŸ³ Start services

      - name: ðŸš€ Deploy to GitHub Pages        run: docker-compose up -d

        id: deployment      

        uses: actions/deploy-pages@v4      - name: â³ Wait for web service

        run: timeout 60 bash -c 'until curl -f http://localhost:8080/health; do sleep 2; done'

  docker-build:      

    name: Build Docker Images      - name: ðŸ”¦ Run Lighthouse CI

    runs-on: ubuntu-latest        run: |

    needs: build-and-test          npm install -g @lhci/cli

              lhci autorun --collect.url=http://localhost:8080 || echo "Lighthouse failed but continuing..."

    steps:        env:

      - name: ðŸ“¥ Checkout code          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

        uses: actions/checkout@v4      

            - name: ðŸ“¤ Upload Lighthouse Report

      - name: ðŸ³ Set up Docker Buildx        if: always()

        uses: docker/setup-buildx-action@v3        uses: actions/upload-artifact@v4

              with:

      - name: ðŸ—ï¸ Build API Image          name: lighthouse-report

        uses: docker/build-push-action@v5          path: .lighthouseci/

        with:          retention-days: 7

          context: ./apps/api      

          file: ./apps/api/Dockerfile      - name: ðŸ›‘ Stop services

          push: false        if: always()

          tags: focus-api:latest        run: docker-compose down

          cache-from: type=gha  

          cache-to: type=gha,mode=max  deploy-pages:

          name: Deploy to GitHub Pages

      - name: ðŸ—ï¸ Build Web Image    runs-on: ubuntu-latest

        uses: docker/build-push-action@v5    needs: [build-and-test, e2e-tests]

        with:    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

          context: ./apps/web    

          file: ./apps/web/Dockerfile    permissions:

          push: false      contents: read

          tags: focus-web:latest      pages: write

          cache-from: type=gha      id-token: write

          cache-to: type=gha,mode=max    

    environment:

  summary:      name: github-pages

    name: CI/CD Summary      url: ${{ steps.deployment.outputs.page_url }}

    runs-on: ubuntu-latest    

    needs: [build-and-test, e2e-tests, lighthouse, deploy-pages, docker-build]    steps:

    if: always()      - name: ðŸ“¥ Checkout code

            uses: actions/checkout@v4

    steps:      

      - name: ðŸ“Š Generate Summary      - name: ðŸŸ¢ Setup Node.js

        run: |        uses: actions/setup-node@v4

          echo "## ðŸŽ¯ CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY        with:

          echo "" >> $GITHUB_STEP_SUMMARY          node-version: ${{ env.NODE_VERSION }}

          echo "### Jobs Status:" >> $GITHUB_STEP_SUMMARY      

          echo "- Build & Tests: ${{ needs.build-and-test.result }}" >> $GITHUB_STEP_SUMMARY      - name: ðŸ“¦ Install dependencies (Web)

          echo "- E2E Tests: ${{ needs.e2e-tests.result }}" >> $GITHUB_STEP_SUMMARY        working-directory: ./apps/web

          echo "- Lighthouse: ${{ needs.lighthouse.result }}" >> $GITHUB_STEP_SUMMARY        run: npm ci

          echo "- Deploy Pages: ${{ needs.deploy-pages.result }}" >> $GITHUB_STEP_SUMMARY      

          echo "- Docker Build: ${{ needs.docker-build.result }}" >> $GITHUB_STEP_SUMMARY      - name: ðŸ—ï¸ Build for production

          echo "" >> $GITHUB_STEP_SUMMARY        working-directory: ./apps/web

          echo "### ðŸ”— Links:" >> $GITHUB_STEP_SUMMARY        run: npm run build

          echo "- [PWA ao vivo](https://edumanzur.github.io/bootcamp2-chrome-ext-Eduardo-Manzur/)" >> $GITHUB_STEP_SUMMARY        env:

          echo "- [RepositÃ³rio](https://github.com/edumanzur/bootcamp2-chrome-ext-Eduardo-Manzur)" >> $GITHUB_STEP_SUMMARY          VITE_API_URL: https://focus-api.onrender.com

      
      - name: ðŸ“‹ Create documentation index
        run: |
          mkdir -p deploy
          cp -r apps/web/dist/* deploy/
          cp README.md deploy/README.md || true
      
      - name: ðŸ“„ Setup Pages
        uses: actions/configure-pages@v4
      
      - name: ðŸ“¤ Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: deploy
      
      - name: ðŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
  
  docker-build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ðŸ—ï¸ Build API image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/api
          file: ./apps/api/Dockerfile
          push: false
          tags: focus-api:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: ðŸ—ï¸ Build Web image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/web
          file: ./apps/web/Dockerfile
          push: false
          tags: focus-web:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: âœ… Test Docker Compose
        run: |
          docker-compose up -d
          sleep 10
          docker-compose ps
          curl -f http://localhost:3000/api/health || exit 1
          curl -f http://localhost:8080/health || exit 1
          docker-compose down

  summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [build-and-test, e2e-tests, lighthouse, deploy-pages, docker-build]
    if: always()
    
    steps:
      - name: ðŸ“Š Generate Summary
        run: |
          echo "## ðŸŽ¯ Focus PWA - Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Jobs Completed" >> $GITHUB_STEP_SUMMARY
          echo "- Build & Test: ${{ needs.build-and-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- E2E Tests: ${{ needs.e2e-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Lighthouse: ${{ needs.lighthouse.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Deploy: ${{ needs.deploy-pages.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Docker Build: ${{ needs.docker-build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
          echo "- [PWA Demo](https://edumanzur.github.io/Focus)" >> $GITHUB_STEP_SUMMARY
          echo "- [Repository](https://github.com/edumanzur/Focus)" >> $GITHUB_STEP_SUMMARY
