name: CI/CD Pipeline - Focus PWAname: CI/CD Pipeline - Focus PWAname: CI - Focus Extension



on:

  push:

    branches: [ main ]on:on:

  pull_request:

    branches: [ main ]  push:  push:

  workflow_dispatch:

    branches: [ main, develop ]    branches: [ main ]

env:

  NODE_VERSION: '20'  pull_request:  pull_request:



jobs:    branches: [ main ]    branches: [ main ]

  build-and-test:

    name: Build & Unit Tests  workflow_dispatch:  workflow_dispatch: # Permite execuÃ§Ã£o manual

    runs-on: ubuntu-latest

    

    steps:

      - name: ðŸ“¥ Checkout codeenv:jobs:

        uses: actions/checkout@v4

        NODE_VERSION: '20'  test-build:

      - name: ðŸŸ¢ Setup Node.js

        uses: actions/setup-node@v4    name: Build e Test E2E

        with:

          node-version: ${{ env.NODE_VERSION }}jobs:    runs-on: ubuntu-latest

          cache: 'npm'

        build-and-test:    

      - name: ðŸ“¦ Install dependencies (Root)

        run: npm ci    name: Build & Test    steps:

      

      - name: ðŸ“¦ Install dependencies (API)    runs-on: ubuntu-latest      - name: Checkout cÃ³digo

        working-directory: ./apps/api

        run: npm ci            uses: actions/checkout@v4

      

      - name: ðŸ“¦ Install dependencies (Web)    strategy:      

        working-directory: ./apps/web

        run: npm ci      matrix:      - name: Setup Node.js

      

      - name: ðŸ§ª Run unit tests (API)        node-version: [20]        uses: actions/setup-node@v4

        working-directory: ./apps/api

        run: npm test --if-present            with:

      

      - name: ðŸ§ª Run unit tests (Web)    steps:          node-version: '20'

        working-directory: ./apps/web

        run: npm test --if-present      - name: ðŸ“¥ Checkout code      

      

      - name: ðŸ—ï¸ Build Web PWA        uses: actions/checkout@v4      - name: Instalar dependÃªncias

        working-directory: ./apps/web

        run: npm run build              run: npm install

        env:

          VITE_API_URL: https://focus-api.onrender.com      - name: ðŸŸ¢ Setup Node.js ${{ matrix.node-version }}      

      

      - name: ðŸ“¤ Upload build artifacts        uses: actions/setup-node@v4      - name: Instalar Playwright Chromium

        uses: actions/upload-artifact@v4

        with:        with:        run: npx playwright install --with-deps chromium

          name: web-dist

          path: apps/web/dist          node-version: ${{ matrix.node-version }}      

          retention-days: 7

          cache: 'npm'      - name: Build da extensÃ£o

  e2e-tests:

    name: E2E Tests with Playwright              run: npm run build

    runs-on: ubuntu-latest

    needs: build-and-test      - name: ðŸ“¦ Install dependencies (API)      

    

    steps:        working-directory: ./apps/api      - name: Verificar arquivos gerados

      - name: ðŸ“¥ Checkout code

        uses: actions/checkout@v4        run: npm ci        run: |

      

      - name: ðŸŸ¢ Setup Node.js                ls -la dist/

        uses: actions/setup-node@v4

        with:      - name: ðŸ“¦ Install dependencies (Web)          test -f dist/extension.zip && echo "âœ… extension.zip criado" || echo "âŒ extension.zip nÃ£o encontrado"

          node-version: ${{ env.NODE_VERSION }}

              working-directory: ./apps/web      

      - name: ðŸ“¦ Install dependencies

        run: |        run: npm ci      - name: Executar testes E2E

          npm ci

          cd apps/api && npm ci              run: npm run test:e2e

          cd ../web && npm ci

            - name: ðŸ§ª Run unit tests (API)        continue-on-error: false

      - name: ðŸ“¦ Install Playwright

        run: npx playwright install --with-deps chromium        working-directory: ./apps/api      

      

      - name: ðŸ³ Start services with Docker Compose        run: npm test --if-present      - name: Publicar relatÃ³rio do Playwright

        run: |

          docker-compose up -d api web              if: always()

          docker-compose ps

            - name: ðŸ§ª Run unit tests (Web)        uses: actions/upload-artifact@v4

      - name: â³ Wait for services

        run: |        working-directory: ./apps/web        with:

          echo "Aguardando API..."

          timeout 60 bash -c 'until curl -f http://localhost:3000/api/health; do sleep 2; done'        run: npm test --if-present          name: playwright-report

          echo "Aguardando Web..."

          timeout 60 bash -c 'until curl -f http://localhost:8080; do sleep 2; done'                path: playwright-report

      

      - name: ðŸ§ª Run E2E tests      - name: ðŸ—ï¸ Build Web PWA          retention-days: 30

        run: npx playwright test

        env:        working-directory: ./apps/web      

          E2E_BASE_URL: http://localhost:8080

          API_URL: http://localhost:3000        run: npm run build      - name: Publicar pacote da extensÃ£o

      

      - name: ðŸ“Š Upload Playwright Report        env:        if: success()

        if: always()

        uses: actions/upload-artifact@v4          VITE_API_URL: https://focus-api.onrender.com        uses: actions/upload-artifact@v4

        with:

          name: playwright-report              with:

          path: playwright-report

          retention-days: 30      - name: ðŸ“¤ Upload build artifacts          name: extension-zip

      

      - name: ðŸ³ Stop Docker services        uses: actions/upload-artifact@v4          path: dist/extension.zip

        if: always()

        run: docker-compose down        with:          retention-days: 90



  lighthouse:          name: web-dist      

    name: Lighthouse CI

    runs-on: ubuntu-latest          path: apps/web/dist      - name: Publicar dist completo

    needs: build-and-test

              retention-days: 7        if: success()

    steps:

      - name: ðŸ“¥ Checkout code          uses: actions/upload-artifact@v4

        uses: actions/checkout@v4

        e2e-tests:        with:

      - name: ðŸŸ¢ Setup Node.js

        uses: actions/setup-node@v4    name: E2E Tests with Playwright          name: extension-dist

        with:

          node-version: ${{ env.NODE_VERSION }}    runs-on: ubuntu-latest          path: dist/

      

      - name: ðŸ“¦ Install dependencies    needs: build-and-test          retention-days: 30

        run: |

          npm ci    

          cd apps/api && npm ci    steps:

          cd ../web && npm ci      - name: ðŸ“¥ Checkout code

              uses: actions/checkout@v4

      - name: ðŸ³ Start services      

        run: |      - name: ðŸŸ¢ Setup Node.js

          docker-compose up -d api web        uses: actions/setup-node@v4

          timeout 60 bash -c 'until curl -f http://localhost:8080; do sleep 2; done'        with:

                node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“Š Run Lighthouse CI      

        run: |      - name: ðŸ“¦ Install Playwright

          npm install -g @lhci/cli        run: |

          lhci autorun          npm ci

        env:          npx playwright install --with-deps chromium

          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}      

            - name: ðŸ³ Start services with Docker Compose

      - name: ðŸ“¤ Upload Lighthouse results        run: |

        if: always()          docker-compose up -d api web

        uses: actions/upload-artifact@v4          docker-compose ps

        with:      

          name: lighthouse-results      - name: â³ Wait for services

          path: .lighthouseci        run: |

          retention-days: 30          echo "Aguardando API..."

                timeout 60 bash -c 'until curl -f http://localhost:3000/api/health; do sleep 2; done'

      - name: ðŸ³ Stop services          echo "Aguardando Web..."

        if: always()          timeout 60 bash -c 'until curl -f http://localhost:8080/health; do sleep 2; done'

        run: docker-compose down      

      - name: ðŸ§ª Run E2E tests

  deploy-pages:        run: npx playwright test tests/pwa.spec.ts

    name: Deploy to GitHub Pages        env:

    runs-on: ubuntu-latest          E2E_BASE_URL: http://localhost:8080

    needs: [build-and-test, e2e-tests]          API_URL: http://localhost:3000

    if: github.ref == 'refs/heads/main' && github.event_name == 'push'      

          - name: ðŸ“¸ Upload Playwright Report

    permissions:        if: always()

      contents: read        uses: actions/upload-artifact@v4

      pages: write        with:

      id-token: write          name: playwright-report

              path: playwright-report/

    environment:          retention-days: 7

      name: github-pages      

      url: ${{ steps.deployment.outputs.page_url }}      - name: ðŸ“Š Upload Test Results

            if: always()

    steps:        uses: actions/upload-artifact@v4

      - name: ðŸ“¥ Checkout code        with:

        uses: actions/checkout@v4          name: test-results

                path: test-results.json

      - name: ðŸŸ¢ Setup Node.js          retention-days: 7

        uses: actions/setup-node@v4      

        with:      - name: ðŸ›‘ Stop Docker Compose

          node-version: ${{ env.NODE_VERSION }}        if: always()

              run: docker-compose down

      - name: ðŸ“¦ Install dependencies (Web)  

        working-directory: ./apps/web  lighthouse:

        run: npm ci    name: Lighthouse Audit

          runs-on: ubuntu-latest

      - name: ðŸ—ï¸ Build for Production    needs: build-and-test

        working-directory: ./apps/web    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

        run: npm run build    

        env:    steps:

          VITE_API_URL: https://focus-api.onrender.com      - name: ðŸ“¥ Checkout code

              uses: actions/checkout@v4

      - name: ðŸ“„ Setup Pages      

        uses: actions/configure-pages@v4      - name: ðŸ“¥ Download build artifacts

              uses: actions/download-artifact@v4

      - name: ðŸ“¤ Upload artifact        with:

        uses: actions/upload-pages-artifact@v3          name: web-dist

        with:          path: apps/web/dist

          path: ./apps/web/dist      

            - name: ðŸ³ Start services

      - name: ðŸš€ Deploy to GitHub Pages        run: docker-compose up -d

        id: deployment      

        uses: actions/deploy-pages@v4      - name: â³ Wait for web service

        run: timeout 60 bash -c 'until curl -f http://localhost:8080/health; do sleep 2; done'

  docker-build:      

    name: Build Docker Images      - name: ðŸ”¦ Run Lighthouse CI

    runs-on: ubuntu-latest        run: |

    needs: build-and-test          npm install -g @lhci/cli

              lhci autorun --collect.url=http://localhost:8080 || echo "Lighthouse failed but continuing..."

    steps:        env:

      - name: ðŸ“¥ Checkout code          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

        uses: actions/checkout@v4      

            - name: ðŸ“¤ Upload Lighthouse Report

      - name: ðŸ³ Set up Docker Buildx        if: always()

        uses: docker/setup-buildx-action@v3        uses: actions/upload-artifact@v4

              with:

      - name: ðŸ—ï¸ Build API Image          name: lighthouse-report

        uses: docker/build-push-action@v5          path: .lighthouseci/

        with:          retention-days: 7

          context: ./apps/api      

          file: ./apps/api/Dockerfile      - name: ðŸ›‘ Stop services

          push: false        if: always()

          tags: focus-api:latest        run: docker-compose down

          cache-from: type=gha  

          cache-to: type=gha,mode=max  deploy-pages:

          name: Deploy to GitHub Pages

      - name: ðŸ—ï¸ Build Web Image    runs-on: ubuntu-latest

        uses: docker/build-push-action@v5    needs: [build-and-test, e2e-tests]

        with:    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

          context: ./apps/web    

          file: ./apps/web/Dockerfile    permissions:

          push: false      contents: read

          tags: focus-web:latest      pages: write

          cache-from: type=gha      id-token: write

          cache-to: type=gha,mode=max    

    environment:

  summary:      name: github-pages

    name: CI/CD Summary      url: ${{ steps.deployment.outputs.page_url }}

    runs-on: ubuntu-latest    

    needs: [build-and-test, e2e-tests, lighthouse, deploy-pages, docker-build]    steps:

    if: always()      - name: ðŸ“¥ Checkout code

            uses: actions/checkout@v4

    steps:      

      - name: ðŸ“Š Generate Summary      - name: ðŸŸ¢ Setup Node.js

        run: |        uses: actions/setup-node@v4

          echo "## ðŸŽ¯ CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY        with:

          echo "" >> $GITHUB_STEP_SUMMARY          node-version: ${{ env.NODE_VERSION }}

          echo "### Jobs Status:" >> $GITHUB_STEP_SUMMARY      

          echo "- Build & Tests: ${{ needs.build-and-test.result }}" >> $GITHUB_STEP_SUMMARY      - name: ðŸ“¦ Install dependencies (Web)

          echo "- E2E Tests: ${{ needs.e2e-tests.result }}" >> $GITHUB_STEP_SUMMARY        working-directory: ./apps/web

          echo "- Lighthouse: ${{ needs.lighthouse.result }}" >> $GITHUB_STEP_SUMMARY        run: npm ci

          echo "- Deploy Pages: ${{ needs.deploy-pages.result }}" >> $GITHUB_STEP_SUMMARY      

          echo "- Docker Build: ${{ needs.docker-build.result }}" >> $GITHUB_STEP_SUMMARY      - name: ðŸ—ï¸ Build for production

          echo "" >> $GITHUB_STEP_SUMMARY        working-directory: ./apps/web

          echo "### ðŸ”— Links:" >> $GITHUB_STEP_SUMMARY        run: npm run build

          echo "- [PWA ao vivo](https://edumanzur.github.io/bootcamp2-chrome-ext-Eduardo-Manzur/)" >> $GITHUB_STEP_SUMMARY        env:

          echo "- [RepositÃ³rio](https://github.com/edumanzur/bootcamp2-chrome-ext-Eduardo-Manzur)" >> $GITHUB_STEP_SUMMARY          VITE_API_URL: https://focus-api.onrender.com

      
      - name: ðŸ“‹ Create documentation index
        run: |
          mkdir -p deploy
          cp -r apps/web/dist/* deploy/
          cp README.md deploy/README.md || true
      
      - name: ðŸ“„ Setup Pages
        uses: actions/configure-pages@v4
      
      - name: ðŸ“¤ Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: deploy
      
      - name: ðŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
  
  docker-build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ðŸ—ï¸ Build API image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/api
          file: ./apps/api/Dockerfile
          push: false
          tags: focus-api:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: ðŸ—ï¸ Build Web image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/web
          file: ./apps/web/Dockerfile
          push: false
          tags: focus-web:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: âœ… Test Docker Compose
        run: |
          docker-compose up -d
          sleep 10
          docker-compose ps
          curl -f http://localhost:3000/api/health || exit 1
          curl -f http://localhost:8080/health || exit 1
          docker-compose down

  summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [build-and-test, e2e-tests, lighthouse, deploy-pages, docker-build]
    if: always()
    
    steps:
      - name: ðŸ“Š Generate Summary
        run: |
          echo "## ðŸŽ¯ Focus PWA - Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Jobs Completed" >> $GITHUB_STEP_SUMMARY
          echo "- Build & Test: ${{ needs.build-and-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- E2E Tests: ${{ needs.e2e-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Lighthouse: ${{ needs.lighthouse.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Deploy: ${{ needs.deploy-pages.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Docker Build: ${{ needs.docker-build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
          echo "- [PWA Demo](https://edumanzur.github.io/Focus)" >> $GITHUB_STEP_SUMMARY
          echo "- [Repository](https://github.com/edumanzur/Focus)" >> $GITHUB_STEP_SUMMARY
