name: CI/CD Pipeline - Focus PWAname: CI - Focus Extension



on:on:

  push:  push:

    branches: [ main, develop ]    branches: [ main ]

  pull_request:  pull_request:

    branches: [ main ]    branches: [ main ]

  workflow_dispatch:  workflow_dispatch: # Permite execuÃ§Ã£o manual



env:jobs:

  NODE_VERSION: '20'  test-build:

    name: Build e Test E2E

jobs:    runs-on: ubuntu-latest

  build-and-test:    

    name: Build & Test    steps:

    runs-on: ubuntu-latest      - name: Checkout cÃ³digo

            uses: actions/checkout@v4

    strategy:      

      matrix:      - name: Setup Node.js

        node-version: [20]        uses: actions/setup-node@v4

            with:

    steps:          node-version: '20'

      - name: ðŸ“¥ Checkout code      

        uses: actions/checkout@v4      - name: Instalar dependÃªncias

              run: npm install

      - name: ðŸŸ¢ Setup Node.js ${{ matrix.node-version }}      

        uses: actions/setup-node@v4      - name: Instalar Playwright Chromium

        with:        run: npx playwright install --with-deps chromium

          node-version: ${{ matrix.node-version }}      

          cache: 'npm'      - name: Build da extensÃ£o

              run: npm run build

      - name: ðŸ“¦ Install dependencies (API)      

        working-directory: ./apps/api      - name: Verificar arquivos gerados

        run: npm ci        run: |

                ls -la dist/

      - name: ðŸ“¦ Install dependencies (Web)          test -f dist/extension.zip && echo "âœ… extension.zip criado" || echo "âŒ extension.zip nÃ£o encontrado"

        working-directory: ./apps/web      

        run: npm ci      - name: Executar testes E2E

              run: npm run test:e2e

      - name: ðŸ§ª Run unit tests (API)        continue-on-error: false

        working-directory: ./apps/api      

        run: npm test --if-present      - name: Publicar relatÃ³rio do Playwright

              if: always()

      - name: ðŸ§ª Run unit tests (Web)        uses: actions/upload-artifact@v4

        working-directory: ./apps/web        with:

        run: npm test --if-present          name: playwright-report

                path: playwright-report

      - name: ðŸ—ï¸ Build Web PWA          retention-days: 30

        working-directory: ./apps/web      

        run: npm run build      - name: Publicar pacote da extensÃ£o

        env:        if: success()

          VITE_API_URL: https://focus-api.onrender.com        uses: actions/upload-artifact@v4

              with:

      - name: ðŸ“¤ Upload build artifacts          name: extension-zip

        uses: actions/upload-artifact@v4          path: dist/extension.zip

        with:          retention-days: 90

          name: web-dist      

          path: apps/web/dist      - name: Publicar dist completo

          retention-days: 7        if: success()

          uses: actions/upload-artifact@v4

  e2e-tests:        with:

    name: E2E Tests with Playwright          name: extension-dist

    runs-on: ubuntu-latest          path: dist/

    needs: build-and-test          retention-days: 30

    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: ðŸ“¦ Install Playwright
        run: |
          npm ci
          npx playwright install --with-deps chromium
      
      - name: ðŸ³ Start services with Docker Compose
        run: |
          docker-compose up -d api web
          docker-compose ps
      
      - name: â³ Wait for services
        run: |
          echo "Aguardando API..."
          timeout 60 bash -c 'until curl -f http://localhost:3000/api/health; do sleep 2; done'
          echo "Aguardando Web..."
          timeout 60 bash -c 'until curl -f http://localhost:8080/health; do sleep 2; done'
      
      - name: ðŸ§ª Run E2E tests
        run: npx playwright test tests/pwa.spec.ts
        env:
          E2E_BASE_URL: http://localhost:8080
          API_URL: http://localhost:3000
      
      - name: ðŸ“¸ Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7
      
      - name: ðŸ“Š Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results.json
          retention-days: 7
      
      - name: ðŸ›‘ Stop Docker Compose
        if: always()
        run: docker-compose down
  
  lighthouse:
    name: Lighthouse Audit
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-dist
          path: apps/web/dist
      
      - name: ðŸ³ Start services
        run: docker-compose up -d
      
      - name: â³ Wait for web service
        run: timeout 60 bash -c 'until curl -f http://localhost:8080/health; do sleep 2; done'
      
      - name: ðŸ”¦ Run Lighthouse CI
        run: |
          npm install -g @lhci/cli
          lhci autorun --collect.url=http://localhost:8080 || echo "Lighthouse failed but continuing..."
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
      
      - name: ðŸ“¤ Upload Lighthouse Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-report
          path: .lighthouseci/
          retention-days: 7
      
      - name: ðŸ›‘ Stop services
        if: always()
        run: docker-compose down
  
  deploy-pages:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [build-and-test, e2e-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      pages: write
      id-token: write
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: ðŸ“¦ Install dependencies (Web)
        working-directory: ./apps/web
        run: npm ci
      
      - name: ðŸ—ï¸ Build for production
        working-directory: ./apps/web
        run: npm run build
        env:
          VITE_API_URL: https://focus-api.onrender.com
      
      - name: ðŸ“‹ Create documentation index
        run: |
          mkdir -p deploy
          cp -r apps/web/dist/* deploy/
          cp README.md deploy/README.md || true
      
      - name: ðŸ“„ Setup Pages
        uses: actions/configure-pages@v4
      
      - name: ðŸ“¤ Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: deploy
      
      - name: ðŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
  
  docker-build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ðŸ—ï¸ Build API image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/api
          file: ./apps/api/Dockerfile
          push: false
          tags: focus-api:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: ðŸ—ï¸ Build Web image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/web
          file: ./apps/web/Dockerfile
          push: false
          tags: focus-web:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: âœ… Test Docker Compose
        run: |
          docker-compose up -d
          sleep 10
          docker-compose ps
          curl -f http://localhost:3000/api/health || exit 1
          curl -f http://localhost:8080/health || exit 1
          docker-compose down

  summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [build-and-test, e2e-tests, lighthouse, deploy-pages, docker-build]
    if: always()
    
    steps:
      - name: ðŸ“Š Generate Summary
        run: |
          echo "## ðŸŽ¯ Focus PWA - Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Jobs Completed" >> $GITHUB_STEP_SUMMARY
          echo "- Build & Test: ${{ needs.build-and-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- E2E Tests: ${{ needs.e2e-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Lighthouse: ${{ needs.lighthouse.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Deploy: ${{ needs.deploy-pages.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Docker Build: ${{ needs.docker-build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
          echo "- [PWA Demo](https://edumanzur.github.io/Focus)" >> $GITHUB_STEP_SUMMARY
          echo "- [Repository](https://github.com/edumanzur/Focus)" >> $GITHUB_STEP_SUMMARY
